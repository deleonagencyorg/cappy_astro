---
// src/views/Products/Detail/index.astro
import { t } from '../../../i18n/i18n';
import type { Locale } from '../../../i18n/i18n';
import './styles.css';
import ProductsCarousel from '../../../components/common/ProductsCarousel/index.astro';
import LazyImage from '../../../components/common/LazyImage.astro';


// Interfaces locales
interface ProductSize {
  value: string;
  image: string;
}

interface Stockist {
  id: string;
  name: string;
  icon: string;
  link: string;
}

interface Product {
  id: string;
  name: string;
  image: string;
  available?: string;
  background_image: string;
  background_color: string;
  header_text_color: string;
  color_button: string;
  sizes: ProductSize[];
  description?: string;
  short_description?: string;
  presentaciones?: Array<{
    value: string;
    icono: string;
  }>;
  // relatedProducts es opcional ya que no existe en la estructura actual
  relatedProducts?: string[];
  weight?: string[];
}

const { currentLang, productId } = Astro.props;

// Obtener datos desde traducciones
const productsAssets = t('home', { namespace: 'products', locale: currentLang }) || {};

const products = t('items', { namespace: 'products', locale: currentLang as Locale }) || [];
const stockists = t('stockist', { namespace: 'products', locale: currentLang as Locale }) || [];
const product = products.find((item: Product) => item.id === productId);
const detailPage = t('detailPage', { namespace: 'products', locale: currentLang as Locale }) || {};
const brandsAssets = t('', { namespace: 'brands', locale: currentLang }) || {};
const newsAssets =  t('', { namespace: 'news', locale: currentLang }) || {};
const brandsList = brandsAssets.brands || [];
const zibasBrand = brandsList.find((brand: any) => brand.id === 'cappy');
const zibasProducts = (zibasBrand?.products || []).filter((product: any) => product.id !== productId);

function hashStringToInt(value: string) {
  return Array.from(value || '').reduce((acc, ch) => ((acc * 31) + ch.charCodeAt(0)) >>> 0, 0);
}

// Si el producto no existe, lanzar error
if (!product || Object.keys(product).length === 0) {
  throw new Error(t('errors.product_not_found', { locale: currentLang }));
}

// Asegurar que todas las propiedades necesarias existan
const safeProduct: Product = {
  id: product.id || '',
  name: product.name || '',
  image: product.image || '',
  background_image: product.background_image || '',
  background_color: product.background_color || '',
  header_text_color: product.header_text_color || '#000000',
  color_button: product.color_button || '#000000',
  sizes: Array.isArray(product.sizes) ? product.sizes : [],
  available: product.available || '',
  description: product.description || '',
  weight: Array.isArray(product.weight) ? product.weight : [],
};

// Nutrition data: prefer per-item override, fallback to generic detailPage
const nutrition = (product as any)?.nutrition || (detailPage as any)?.nutrition || null;

const brandChipImages = [
  (zibasBrand as any)?.imageChip1,
  (zibasBrand as any)?.imageChip2,
  (zibasBrand as any)?.imageChip3,
  (zibasBrand as any)?.imageChip4,
].filter(Boolean) as string[];

const chipImage =
  (product as any)?.chip_image ||
  (brandChipImages.length
    ? brandChipImages[hashStringToInt(safeProduct.id) % brandChipImages.length]
    : '') ||
  (detailPage as any)?.crunch?.image ||
  safeProduct.image;

// Obtener todos los productos como un array
const productsData = t('items', { locale: currentLang, namespace: 'products' }) || [];
const allProductsArray = Array.isArray(productsData) ? productsData : [];

// Mostrar todos los productos excepto el actual
let relatedProducts: any[] = [];
if (allProductsArray.length > 1) {
  relatedProducts = allProductsArray.filter((p: any) => p.id !== productId);
}


---
  <main class="bg-primary w-full flex flex-col items-center justify-center mt-0"> 
{safeProduct.background_color && (
  <article
    id="product-detail"
    class="product-detail bg-yellow pt-8 pb-10 md:pt-12 md:pb-14"
  >
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-14 items-center lg:items-start">
        <div class="w-full">
          <h1 class="pd-anim pd-anim-left pd-delay-1 text-blue font-title italic font-extrabold leading-[0.95] text-4xl sm:text-5xl md:text-6xl lg:text-7xl">
            {safeProduct.name}
          </h1>

          <p class="pd-anim pd-anim-left pd-delay-2 mt-4 sm:mt-6 text-blue font-text italic font-medium text-base sm:text-lg md:text-xl max-w-xl">
            {safeProduct.description}
          </p>

          <div class="mt-8 sm:mt-10">
            <h2 class="pd-anim pd-anim-left pd-delay-3 text-blue font-title italic font-extrabold text-xl sm:text-2xl md:text-3xl">
              {detailPage?.presentationsTitle}
            </h2>
            <p class="pd-anim pd-anim-left pd-delay-4 mt-2 sm:mt-3 text-blue font-text italic font-medium text-sm sm:text-base md:text-lg">
              {detailPage?.presentationsNote}
            </p>

            {safeProduct.weight && safeProduct.weight.length > 0 && (
              <div class="pd-anim pd-anim-left pd-delay-5 mt-4 sm:mt-5 flex flex-wrap gap-2 sm:gap-3">
                {safeProduct.weight.map((weight) => (
                  <span class="px-4 py-2 sm:px-5 sm:py-3 rounded-[14px] border-2 border-blue text-blue font-title italic font-extrabold text-sm sm:text-base md:text-lg bg-yellow">
                    {weight}
                  </span>
                ))}
              </div>
            )}
          </div>

          <div class="mt-8 sm:mt-10 border-t-2 border-blue/30"></div>
          {nutrition && (
            <details class="pd-anim pd-anim-left mt-4 rounded-2xl bg-yellow/40 border-2 border-blue/30">
              <summary class="cursor-pointer select-none px-5 sm:px-6 py-4 sm:py-5 flex items-center justify-between text-blue font-title italic font-extrabold text-lg sm:text-xl md:text-2xl">
                <span>{nutrition.title}</span>
                <span class="text-blue font-title italic font-extrabold">+</span>
              </summary>
              <div class="px-5 sm:px-6 pb-5 sm:pb-6">
                {nutrition?.serving && (
                  <div class="text-blue font-text italic font-medium text-sm sm:text-base mb-3">
                    {nutrition.serving}
                  </div>
                )}
                <div class="w-full overflow-hidden rounded-xl border-2 border-blue/20 bg-white/40">
                  <table class="w-full text-left">
                    <tbody>
                      {Array.isArray(nutrition?.rows) && nutrition.rows.map((row: any) => (
                        <tr class="border-b border-blue/10 last:border-b-0">
                          <td class="px-4 py-3 text-blue font-text italic font-medium text-sm sm:text-base">{row.label}</td>
                          <td class="px-4 py-3 text-blue font-title italic font-extrabold text-sm sm:text-base">{row.value}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                {nutrition?.disclaimer && (
                  <div class="mt-3 text-blue/80 font-text italic text-sm">{nutrition.disclaimer}</div>
                )}
              </div>
            </details>
          )}
        </div>

        <div class="w-full flex justify-center lg:justify-end">
          <div class="pd-anim pd-anim-right pd-delay-2 relative w-full max-w-[520px] rounded-[28px] bg-orange overflow-hidden p-7 sm:p-9 md:p-12">
            {safeProduct.background_image && (
              <div
                class="absolute inset-0 bg-center bg-cover bg-no-repeat"
                style={{ backgroundImage: `url(${safeProduct.background_image})` }}
              ></div>
            )}
            <LazyImage
              id="product-image"
              class="relative z-10 w-full h-auto object-contain"
              src={safeProduct.image}
              alt={safeProduct.name}
              transition:name={`product-image-${safeProduct.id}`}
            />
          </div>
        </div>
      </div>
    </div>
  </article>
)}



<!-- {detailPage?.crunch && (
  <section class="w-full bg-yellow py-10 md:py-14">
    <div class="container mx-auto px-4">
      <div class="pd-anim rounded-[28px] bg-orange p-6 sm:p-8 md:p-10 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
        <div>
          <h2 class="text-white font-title italic font-extrabold text-3xl sm:text-4xl md:text-5xl leading-[0.95]">
            {detailPage.crunch.title}
          </h2>
          <p class="mt-3 sm:mt-4 text-white/95 font-text italic font-medium text-sm sm:text-base md:text-lg max-w-xl">
            {detailPage.crunch.description}
          </p>
        </div>
        <div class="flex justify-center md:justify-end">
          <LazyImage
            src={detailPage.crunch.image}
            alt={detailPage.crunch.title}
            class="w-full max-w-[360px] h-auto object-contain"
            loading="lazy"
          />
        </div>
      </div>
    </div>
  </section>
)} -->

{products.length > 0 && (
  <section class="w-full bg-yellow pb-10 md:pb-14">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between mb-6 md:mb-8">
        <h2 class="pd-anim text-blue font-title italic font-extrabold text-3xl sm:text-4xl md:text-5xl leading-[0.95]">
          {detailPage?.flavorsTitle}
        </h2>
      </div>
      <div class="md:pl-0 pl-2 pr-0">
        <ProductsCarousel
          products={relatedProducts}
          autoplay={true}
          speed={4000}
          slidesPerView={3}
          spaceBetween={16}
          loop={true}
          paddingTop="24px"
          mobilePaddingTop="16px"
          className="max-w-4xl mx-auto"
        />
      </div>
    </div>
  </section>
)}

{detailPage?.doubts && (
  <section class="w-full bg-yellow pb-16 md:pb-20">
    <div class="container mx-auto px-4">
      <div class="pd-anim rounded-[28px] bg-red p-6 sm:p-8 md:p-10 grid grid-cols-1 md:grid-cols-2 gap-8 items-center overflow-hidden">
        <div>
          <h2 class="text-white font-title italic font-extrabold text-3xl sm:text-4xl md:text-5xl leading-[0.95]">
            {detailPage.doubts.title}
          </h2>
          <p class="mt-3 sm:mt-4 text-white/95 font-text italic font-medium text-sm sm:text-base md:text-lg max-w-xl">
            {detailPage.doubts.description}
          </p>
          <a
            href={`/${currentLang}/${currentLang === 'es' ? 'contacto' : 'contact'}`}
            class="inline-flex mt-6 items-center justify-center rounded-full bg-white text-red font-title italic font-extrabold px-7 py-3"
          >
            {detailPage.doubts.buttonText}
          </a>
        </div>
        <div class="flex justify-center md:justify-end">
          <LazyImage
            src={detailPage.doubts.image}
            alt={detailPage.doubts.title}
            class="w-full max-w-[360px] sm:max-w-[420px] h-auto object-contain"
            loading="lazy"
          />
        </div>
      </div>
    </div>
  </section>
)}
</main>