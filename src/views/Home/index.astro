<!-- src/views/Home/index.astro -->
---
import LazyImage from '../../components/common/LazyImage.astro';
// Component Imports
import VideoCarousel from '../../components/common/VideoCarousel/index.astro';
import BackToSchoolSection from '../../components/home/BackToSchoolSection.astro';
import FullWidthVideoSection from '../../components/home/FullWidthVideoSection.astro';
import GamesSection from '../../components/home/GamesSection.astro';
import RecipesCarousel from "../../components/recipes/RecipesCarousel.astro";
import ProductsCarousel from '../../components/common/ProductsCarousel/index.astro';
import MasonryGallery from '../../components/gallery/MasonryGallery.astro';
import PixelGrid from '../../components/atoms/PixelGrid.astro';
import BlogCard from '../../components/blog/BlogCard.astro';


// Style Imports
import './styles.css';

// i18n and Data Imports
import { t, getLocale } from '../../i18n/i18n';
import { InstagramEmbed } from 'react-social-media-embed';



// Props
export interface Props {
  loading?: boolean;
}
const { loading = false } = Astro.props;

// Language and Data Setup
const currentLang = getLocale();
const homeAssets = t('home', { namespace: 'common', locale: currentLang }) || {};
const recipesAssets = t('', { namespace: 'recipes', locale: currentLang }) || {};
const galleryAssets = t('', { namespace: 'gallery', locale: currentLang }) || {};
const aboutAssets = t('', { namespace: 'aboutus', locale: currentLang }) || {};
const brandsAssets = t('', { namespace: 'brands', locale: currentLang }) || {};
const newsAssets =  t('', { namespace: 'news', locale: currentLang }) || {};
const products = t('items', { namespace: 'products', locale: currentLang }) || [];
const brandsList = brandsAssets.brands || [];
const cappyBrand = brandsList.find((brand: any) => brand.id === 'cappy');
const cappyProducts = cappyBrand?.products || [];
const games = t('games', { namespace: 'common', locale: currentLang }) || [];

const commonAssets = t('assets.slider', { namespace: 'common', locale: currentLang }) || [];
const slides = Array.isArray(commonAssets)
  ? commonAssets
    .filter(asset => asset && typeof asset === 'object')
    .map(asset => {
      if (asset.type === 'html' && asset.html) {
        return {
          type: 'html' as const,
          html: asset.html
        };
      } else if (asset.type === 'video') {
        return {
          type: 'video' as const,
          desktop: asset.desktop,
          mobile: asset.mobile,
          alt: asset.alt || "Cappy",
          title: asset.title || '',
          subtitle: asset.description || '',
          link: asset.url || asset.link || ''
        };
      } else {
        return {
          type: 'image' as const,
          desktop: asset.desktop,
          mobile: asset.mobile,
          alt: asset.alt || "Cappy",
          title: asset.title || '',
          subtitle: asset.description || '',
          link: asset.url || asset.link || ''
        };
      }
    })
  : [];

// Load latest blog posts by current language from markdown
const blogModules = import.meta.glob('../../locales/*/blog/*.md');
let latestBlogPosts: Array<{ id: string; slug: string; title: string; image?: string; published_date?: string; }>= [];
for (const path in blogModules) {
  const lang = path.split('/')[3];
  if (lang === currentLang) {
    const mod: any = await blogModules[path]();
    const fm = mod.frontmatter || {};
    if (fm && fm.id && fm.slug && fm.title) {
      latestBlogPosts.push({
        id: String(fm.id),
        slug: String(fm.slug),
        title: String(fm.title),
        image: fm.image ? String(fm.image) : '/images/blog/placeholder.jpg',
        published_date: fm.published_date ? String(fm.published_date) : ''
      });
    }
  }
}
function toDate(s?: string){
  if(!s) return 0; 
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){ const [d,m,y]=s.split('/').map(Number); return new Date(y,(m||1)-1,d||1).getTime(); }
  const t=Date.parse(s); return isNaN(t)?0:t;
}
latestBlogPosts = latestBlogPosts.sort((a,b)=> toDate(b.published_date)-toDate(a.published_date)).slice(0,5);
const noNewsText = currentLang==='es' ? 'No se encuentra novedades aún para mostrar' : 'There are no updates to show yet';
const topNewsLabel = currentLang==='es' ? 'NOTICIAS MÁS IMPORTANTES' : 'TOP NEWS';
const featuredLabel = currentLang==='es' ? 'DESTACADOS' : 'FEATURED';

---

  <main class="bg-primary w-full flex flex-col items-center justify-center mt-0" data-page="home">
    <!-- Slider Section con VideoCarousel -->
    <div class="relative w-full overflow-hidden py-4 bg-yellow" data-animate="bounce" data-animate-delay="0">
      <div class="w-[90%] mx-auto h-[500px] overflow-hidden shadow-xl rounded-none md:rounded-[24px]">
        <VideoCarousel 
          slides={slides} 
          height="500px" 
          mobileHeight="500px" 
          showOverlay={true}
          width="100%"
          borderRadius="0"
        />
      </div>
    </div>
    
    <!-- Sección Back To School -->
    <div data-animate="bounce" data-animate-delay="80">
      <BackToSchoolSection />
    </div>
    
    <!-- Sección de Productos Cappy -->
    {cappyProducts.length > 0 && (
      <section id="products" class="w-full bg-yellow py-12 md:py-16" data-animate="bounce" data-animate-delay="140">
        <div class="container mx-auto px-6">
          <div class="grid grid-cols-1 md:grid-cols-[40%_65%] gap-8 md:gap-12 items-center">
            {/* Columna de textos */}
            <div class="space-y-4 md:space-y-6">
              {brandsAssets.home?.title && (
                <h2 class="text-4xl md:text-5xl lg:text-6xl font-black leading-tight text-blue">
                  {brandsAssets.home?.title}
                </h2>
              )}
              {brandsAssets.home?.subtitle && (
                <h3 class="text-2xl md:text-3xl font-bold text-blue">
                  {brandsAssets.home?.subtitle}
                </h3>
              )}
              <div class="pt-2">
                <a
                  href={`/${currentLang}/${currentLang === 'es' ? 'productos' : 'products'}`}
                  class="inline-flex items-center px-8 py-3 rounded-full bg-blue text-white font-semibold text-sm md:text-base shadow-md hover:shadow-lg transition-all duration-200"
                >
                  {currentLang === 'es' ? 'Ver todos los productos' : 'View all products'}
                </a>
              </div>
            </div>

            <div class="w-full overflow-hidden center-items">
              <ProductsCarousel 
                products={products}
                color={'white'}
                autoplay={true}
                speed={4000}
                data-slides-per-view-desktop="3"
                data-slides-per-view-tablet="2"
                data-slides-per-view-mobile="1"
                data-space-between-desktop="20"
                data-space-between-tablet="15"
                data-space-between-mobile="10"
                loop={true}
                className=""
              />
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Sección de Juegos -->
    <div data-animate="bounce" data-animate-delay="220">
      <GamesSection 
        games={games}
        title={currentLang === 'es' ? 'Diviertete con cappy' : 'Have fun with cappy'}
        howToPlay={{
          title: currentLang === 'es' ? '¿Cómo participar?' : 'How to participate?',
          steps: currentLang === 'es' 
            ? [
                'Juega',
                'Toma captura de tu puntaje.',
                'Comparte y comenta en nuestras redes tu experiencia'
              ]
            : [
                'Play',
                'Take a screenshot of your score.',
                'Share and comment on our social media about your experience'
              ]
        }}
        ctaText={currentLang === 'es' ? 'Jugar ahora mismo' : 'Play now'}
        ctaUrl={`/${currentLang}/${currentLang === 'es' ? 'juegos' : 'games'}`}
      />
    </div>

    <!-- Sección de recetas con carrusel -->
    <!-- <section id="recipes" class="w-full py-12" transition:animate="slide">
      <div class="container mx-auto px-4">
        {recipesAssets.home?.title && (
          <div class="text-center mb-16 relative z-20" >
            <h2 class="text-3xl md:text-4xl italic font-bold mb-4" style={`color: #5B3F2E`}>
              {recipesAssets.home?.title}
            </h2>
            {recipesAssets.home?.subtitle && (
              <h1 class="text-6xl md:text-9xl italic font-bold mb-4" style={`color: #5B3F2E`}>
                {recipesAssets.home?.subtitle}
              </h1>
            )}
          </div>
        )}
        <RecipesCarousel 
          title={recipesAssets.home?.title || 'DESCUBRE NUEVOS SABORES CON NUESTRAS'}
          textButton={recipesAssets.home?.view_more || 'Ver Todas'}
        />
      </div>
    </section> -->


    <!-- Sección Gallery -->




    <!-- Sección Abaout -->
<!-- <section id="about" class="bg-red w-full py-12" transition:animate="slide">
  <div class="container mx-auto px-4">
    <div class="text-center mb-8">
      {aboutAssets.title && (
        <div class="text-center mb-16 relative z-20" >
          <h2 class="text-3xl md:text-4xl italic font-bold mb-4 text-white">
            {aboutAssets.title}
          </h2>
          {aboutAssets.subtitle && (
            <h1 class="text-6xl md:text-9xl italic font-bold mb-4 text-white">
              {aboutAssets.subtitle}
            </h1>
          )}
        </div>
      )}
    </div>
    <div class="flex flex-col md:flex-row items-center justify-center gap-8">
      <div>
        <h4 class="md:text-4xl text-lg font-bold text-white font-title">LOREM IPSUM DOLOR</h4>
        <p class="text-white font-sans  text-xl leading-relaxed w-100%">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam nec metus vel ante bibendum finibus. Nullam nec metus vel ante bibendum finibus.</p>
      </div>
      <div>
        <LazyImage src="https://snack.yummiespromociones.com/cappy/gallery16.webp" class="py-4" alt="Cappy" />
      </div>
      <div>
        <LazyImage src="https://snack.yummiespromociones.com/cappy/gallery15.webp" class="py-4" alt="Cappy" />
        <h4 class="md:text-4xl text-lg font-bold text-white font-title">LOREM IPSUM DOLOR</h4>
        <p class="text-white font-sans text-xl  leading-relaxed w-100%">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam nec metus vel ante bibendum finibus. Nullam nec metus vel ante bibendum finibus.</p>
      </div>
    </div>
  </div>
</section> -->

    <!-- Sección de Video a Pantalla Completa -->
    <div data-animate="bounce" data-animate-delay="300">
      <FullWidthVideoSection />
    </div>

  </main>
