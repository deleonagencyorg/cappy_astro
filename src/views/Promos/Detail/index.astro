---
import { t } from '../../../i18n/i18n';
import type { Locale } from '../../../i18n/i18n';
import Breadcrumb from '../../../components/common/Breadcrumb/Breadcrumb.astro';
import LazyImage from '../../../components/common/LazyImage.astro';
import HeroBanner from '../../../components/common/HeroBanner.astro';

interface PromoItem {
  id: string;
  slug: string;
  imagen: string;
  descripcion: string;
  url: string[];
  terminos_y_condiciones_url: string;
  fecha_inicio: string;
  fecha_fin: string;
  detail?: {
    hero?: {
      title?: string;
      subtitle?: string;
      description?: string;
      buttonText?: string;
      buttonUrl?: string;
      backgroundImage?: string;
      backgroundImageMobile?: string;
      image?: string;
      imageMobile?: string;
    };
    about?: { title?: string; content?: string[] };
    steps?: { title?: string; items?: Array<{ title?: string; description?: string }> };
    prizes?: {
      title?: string;
      items?: Array<{ title?: string; description?: string; image?: string }>;
      buttonText?: string;
      buttonUrl?: string;
    };
    terms?: { title?: string; content?: string[]; buttonText?: string };
    faqs?: { title?: string; items?: Array<{ q?: string; a?: string }> };
  };
}

const { currentLang, slug } = Astro.props as { currentLang: Locale; slug: string };

const promosMeta = t('meta', { namespace: 'promos', locale: currentLang }) || {};
const promos = (t('items', { namespace: 'promos', locale: currentLang }) || []) as PromoItem[];
const promo = promos.find((p) => p.slug === slug);

if (!promo) {
  throw new Error(`Promo with slug ${slug} not found`);
}

const baseDomain = 'https://www.cappysnacks.com';
const canonicalUrl = `${baseDomain}/${currentLang}/promos/${promo.slug}`;
const pageTitle = `${promosMeta.title || 'Promociones Cappy'} - ${promo.descripcion}`;
const pageDescription = promo.descripcion;
const defaultOgImage = promo.imagen || `${baseDomain}/logo.png`;

const detail = promo.detail || {};
const hero = detail.hero || {};
const about = detail.about || {};
const steps = detail.steps || {};
const prizes = detail.prizes || {};
const terms = detail.terms || {};
const faqs = detail.faqs || {};

const toDate = (value: string) => {
  const d = new Date(value);
  return Number.isNaN(d.getTime()) ? null : d;
};

const formatDate = (value: string) => {
  const d = toDate(value);
  if (!d) return value;
  const locale = currentLang === 'es' ? 'es-ES' : 'en-US';
  return new Intl.DateTimeFormat(locale, { year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
};

const validityLabel = currentLang === 'es' ? 'Vigencia' : 'Validity';
const linksTitle = currentLang === 'es' ? 'Links' : 'Links';
const backText = currentLang === 'es' ? 'Volver a Promos' : 'Back to promos';

const aboutTitle = about.title || (currentLang === 'es' ? '¿De qué se trata?' : 'What is it about?');
const stepsTitle = steps.title || (currentLang === 'es' ? 'Pasos para participar' : 'How to participate');
const prizesTitle = prizes.title || (currentLang === 'es' ? 'Premios' : 'Prizes');
const termsTitle = terms.title || (currentLang === 'es' ? 'Términos y Condiciones' : 'Terms & Conditions');
const termsButtonText = terms.buttonText || (currentLang === 'es' ? 'Ver términos y condiciones' : 'View terms & conditions');
const faqsTitle = faqs.title || (currentLang === 'es' ? '¿Tienes dudas? te las respondemos' : 'Questions? We’ve got answers');
---

<Fragment slot="head">
  <link rel="canonical" href={canonicalUrl} />
  <meta property="og:url" content={canonicalUrl} />
  <meta property="og:type" content="article" />
  <meta property="og:title" content={pageTitle} />
  <meta property="og:description" content={pageDescription} />
  <meta property="og:image" content={defaultOgImage} />
  <meta property="og:site_name" content="Cappy" />
  <meta property="og:locale" content={currentLang === 'es' ? 'es_ES' : 'en_US'} />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={canonicalUrl} />
  <meta name="twitter:title" content={pageTitle} />
  <meta name="twitter:description" content={pageDescription} />
  <meta name="twitter:image" content={defaultOgImage} />

  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'PromotionCard',
      name: promo.descripcion,
      description: promo.descripcion,
      url: canonicalUrl,
      image: [promo.imagen],
      validFrom: promo.fecha_inicio,
      validThrough: promo.fecha_fin
    })}
  ></script>
</Fragment>

<div class="bg-primary -mt-px -mb-px overflow-hidden">
  <div class="container mx-auto px-4 pt-4 pb-16">
    <Breadcrumb bgColor="bg-transparent" textColor="text-black" hoverColor="hover:text-black" />

    <div class="mt-6 h-[500px] overflow-hidden shadow-xl rounded-none md:rounded-[24px]">
      <HeroBanner
        backgroundImage={hero.backgroundImage || promo.imagen}
        backgroundImageMobile={hero.backgroundImageMobile || hero.backgroundImage || promo.imagen}
        image={hero.image || promo.imagen}
        imageMobile={hero.imageMobile || hero.image || promo.imagen}
        title={hero.title || promo.descripcion}
        subtitle={hero.subtitle}
        description={hero.description}
        buttonText={hero.buttonText}
        buttonUrl={hero.buttonUrl}
      />
    </div>

    <div class="mt-10 md:mt-14 grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 items-start">
      <div class="lg:col-span-7 space-y-8">
        <section>
          <h2 class="font-title text-[#0b2f87] text-3xl md:text-5xl font-black leading-tight">{aboutTitle}</h2>
          <div class="mt-4 rounded-[28px] bg-white/70 border border-black/10 p-6 md:p-8">
            <p class="text-black/70">
              <span class="font-bold">{validityLabel}:</span> {formatDate(promo.fecha_inicio)} - {formatDate(promo.fecha_fin)}
            </p>
            <div class="mt-4 space-y-3">
              {(about.content || []).map((p) => (
                <p class="text-black/80 leading-relaxed">{p}</p>
              ))}
            </div>

            {Array.isArray(promo.url) && promo.url.length > 0 && (
              <div class="mt-6">
                <h3 class="font-title text-xl font-black text-[#0b2f87]">{linksTitle}</h3>
                <div class="mt-3 flex flex-col gap-2">
                  {promo.url.map((u) => (
                    <a class="text-[#0b2f87] underline break-all" href={u} target="_blank" rel="noopener noreferrer">{u}</a>
                  ))}
                </div>
              </div>
            )}
          </div>
        </section>

        <section>
          <h2 class="font-title text-[#0b2f87] text-3xl md:text-5xl font-black leading-tight">{stepsTitle}</h2>

          <div class="mt-4 space-y-4">
            {(steps.items || []).map((item, idx) => (
              <div class="rounded-[22px] bg-white/70 border border-black/10 p-5 md:p-6">
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue text-white flex items-center justify-center font-bold">
                    {idx + 1}
                  </div>
                  <div>
                    <p class="font-title text-xl font-black text-[#0b2f87] leading-tight">
                      {item.title}
                    </p>
                    <p class="mt-1 text-black/80 leading-relaxed">{item.description}</p>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>
      </div>

      <aside class="lg:col-span-5">
        <div class="rounded-[28px] bg-blue text-white shadow-xl overflow-hidden">
          <div class="p-6 md:p-8">
            <h2 class="font-title text-3xl md:text-4xl font-black leading-tight">
              {prizesTitle}
            </h2>

            <div class="mt-6 space-y-4">
              {(prizes.items || []).map((item) => (
                <div class="rounded-[18px] bg-white/10 border border-white/10 p-4">
                  <div class="flex items-start gap-4">
                    <div class="w-14 h-14 rounded-[14px] bg-white/10 overflow-hidden flex items-center justify-center">
                      {item.image ? (
                        <LazyImage src={item.image} alt={item.title || 'Prize'} class="w-full h-full object-cover" width={140} height={140} />
                      ) : (
                        <span class="text-white/80 font-bold">+</span>
                      )}
                    </div>
                    <div>
                      <p class="font-title text-lg font-black leading-tight">{item.title}</p>
                      <p class="mt-1 text-white/85 text-sm leading-relaxed">{item.description}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {(prizes.buttonText && prizes.buttonUrl) && (
            <div class="p-6 md:p-8 pt-0">
              <a
                href={prizes.buttonUrl}
                class="block w-full text-center px-6 py-3 rounded-full bg-white text-blue font-bold transition hover:opacity-90"
              >
                {prizes.buttonText}
              </a>
            </div>
          )}
        </div>
      </aside>
    </div>

    <section class="mt-10 md:mt-14">
      <div class="rounded-[32px] bg-red text-white overflow-hidden shadow-xl">
        <div class="p-6 md:p-10">
          <h2 class="font-title text-3xl md:text-5xl font-black leading-tight">
            {termsTitle}
          </h2>

          <div class="mt-5 space-y-3">
            {(terms.content || []).map((p) => (
              <p class="text-white/90 leading-relaxed">{p}</p>
            ))}
          </div>

          <div class="mt-6">
            <a
              class="inline-block px-8 py-3 rounded-full bg-white text-red font-bold shadow-md hover:shadow-lg transition"
              href={promo.terminos_y_condiciones_url}
              target="_blank"
              rel="noopener noreferrer"
            >
              {termsButtonText}
            </a>
          </div>
        </div>
      </div>
    </section>

    <section class="mt-10 md:mt-14">
      <h2 class="font-title text-[#0b2f87] text-3xl md:text-5xl font-black leading-tight whitespace-pre-line">
        {faqsTitle}
      </h2>

      <div class="mt-6 space-y-3">
        {(faqs.items || []).map((item) => (
          <details class="rounded-[18px] bg-blue text-white shadow-lg overflow-hidden">
            <summary class="cursor-pointer list-none px-5 py-4 flex items-center justify-between gap-4">
              <span class="font-title text-base md:text-lg font-black">{item.q}</span>
              <span class="flex-shrink-0 w-8 h-8 rounded-full bg-white/10 flex items-center justify-center" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </span>
            </summary>
            <div class="px-5 pb-5 text-white/90 leading-relaxed">
              {item.a}
            </div>
          </details>
        ))}
      </div>
    </section>

    <div class="mt-10">
      <a href={`/${currentLang}/promos`} class="inline-block text-[#0b2f87] underline font-bold">{backText}</a>
    </div>
  </div>
</div>
