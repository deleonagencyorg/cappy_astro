---
import { t } from '../../i18n/i18n';
import type { Locale } from '../../i18n/i18n';
import LazyImage from '../../components/common/LazyImage.astro';
import Breadcrumb from '../../components/common/Breadcrumb/Breadcrumb.astro';
import HeroBanner from '../../components/common/HeroBanner.astro';

interface PromoItem {
  id: string;
  slug: string;
  imagen: string;
  descripcion: string;
  url: string[];
  terminos_y_condiciones_url: string;
  fecha_inicio: string;
  fecha_fin: string;
}

export interface Props {
  currentLang: Locale;
}

const { currentLang } = Astro.props;

const promosMeta = t('meta', { namespace: 'promos', locale: currentLang }) || {};
const promosUi = t('ui', { namespace: 'promos', locale: currentLang }) || {};
const promos = (t('items', { namespace: 'promos', locale: currentLang }) || []) as PromoItem[];

const hero = promosUi.hero || {};
const sections = promosUi.sections || {};
const labels = promosUi.labels || {};
const emptyState = promosUi.emptyState || {};
const cta = promosUi.cta || {};

const baseDomain = 'https://www.cappysnacks.com';
const canonicalUrl = `${baseDomain}/${currentLang}/promos/`;
const pageTitle = promosMeta.title || 'Promociones Cappy';
const pageDescription = promosMeta.description || 'Promociones Cappy';
const defaultOgImage = `${baseDomain}/logo.png`;

const toDate = (value: string) => {
  const d = new Date(value);
  return Number.isNaN(d.getTime()) ? null : d;
};

const formatDate = (value: string) => {
  const d = toDate(value);
  if (!d) return value;
  const locale = currentLang === 'es' ? 'es-ES' : 'en-US';
  return new Intl.DateTimeFormat(locale, { year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
};

const now = new Date();
const activePromos = promos.filter((p) => {
  const end = toDate(p.fecha_fin);
  return !end || end.getTime() >= now.getTime();
});

const endedPromos = promos.filter((p) => {
  const end = toDate(p.fecha_fin);
  return !!end && end.getTime() < now.getTime();
});

activePromos.sort((a, b) => (toDate(a.fecha_fin)?.getTime() || 0) - (toDate(b.fecha_fin)?.getTime() || 0));
endedPromos.sort((a, b) => (toDate(b.fecha_fin)?.getTime() || 0) - (toDate(a.fecha_fin)?.getTime() || 0));
---

<Fragment slot="head">
  <link rel="canonical" href={canonicalUrl} />
  <meta property="og:url" content={canonicalUrl} />
  <meta property="og:type" content="website" />
  <meta property="og:title" content={pageTitle} />
  <meta property="og:description" content={pageDescription} />
  <meta property="og:image" content={defaultOgImage} />
  <meta property="og:site_name" content="Cappy" />
  <meta property="og:locale" content={currentLang === 'es' ? 'es_ES' : 'en_US'} />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={canonicalUrl} />
  <meta name="twitter:title" content={pageTitle} />
  <meta name="twitter:description" content={pageDescription} />
  <meta name="twitter:image" content={defaultOgImage} />

  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'CollectionPage',
      name: pageTitle,
      description: pageDescription,
      url: canonicalUrl
    })}
  ></script>
</Fragment>

<div class="bg-primary -mt-px -mb-px overflow-hidden">
  <div class="container mx-auto px-4 pt-4 pb-16">
    <Breadcrumb bgColor="bg-transparent" textColor="text-black" hoverColor="hover:text-black" />

    <div class="mt-6 h-[500px] overflow-hidden shadow-xl rounded-none md:rounded-[24px]">
      <HeroBanner
        backgroundImage={hero.backgroundImage}
        backgroundImageMobile={hero.backgroundImageMobile}
        image={hero.image}
        imageMobile={hero.imageMobile}
        title={hero.title}
        subtitle={hero.subtitle}
        description={hero.description}
        buttonText={hero.buttonText}
        buttonUrl={hero.buttonUrl}
      />
    </div>

    <section class="mt-10 md:mt-14">
      <div class="flex items-start justify-between gap-6">
        <h2 class="font-title text-[#0b2f87] text-3xl md:text-5xl lg:text-6xl font-black leading-tight whitespace-pre-line">
          {sections.activeTitle}
        </h2>

        <div class="flex gap-2 md:gap-3">
          <button
            type="button"
            class="md:hidden w-9 h-9 rounded-full border border-black/20 bg-primary/60 hover:bg-primary/80 transition flex items-center justify-center"
            aria-label="Previous"
            data-scroll-left="active"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <button
            type="button"
            class="md:hidden w-9 h-9 rounded-full border border-black/20 bg-primary/60 hover:bg-primary/80 transition flex items-center justify-center"
            aria-label="Next"
            data-scroll-right="active"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>

      {activePromos.length === 0 ? (
        <div class="mt-6 rounded-[28px] bg-white/70 border border-black/10 p-8">
          <p class="font-title text-2xl text-[#0b2f87] font-bold">{emptyState.title}</p>
          <p class="mt-2 text-black/70">{emptyState.description}</p>
        </div>
      ) : (
        <>
          <div class="mt-6 md:hidden flex gap-4 overflow-x-auto snap-x snap-mandatory pb-2" data-carousel="active">
            {activePromos.map((promo) => (
              <article class="snap-start shrink-0 w-[280px] rounded-[28px] bg-blue text-white shadow-lg overflow-hidden flex flex-col">
                <div class="p-5">
                  <div class="flex items-start justify-between gap-3">
                    <div class="w-14 h-14 rounded-full bg-white/10 overflow-hidden">
                      <LazyImage
                        src={promo.imagen}
                        alt={promo.descripcion}
                        class="w-full h-full object-cover"
                        width={200}
                        height={200}
                      />
                    </div>
                    <span class="px-3 py-1 rounded-full bg-white text-blue text-xs font-bold">
                      {labels.activeBadge}
                    </span>
                  </div>

                  <h3 class="mt-4 font-title text-xl font-black leading-tight">
                    {promo.descripcion}
                  </h3>
                  <p class="mt-2 text-white/85 text-sm">
                    <span class="font-bold">{labels.validity}:</span> {formatDate(promo.fecha_inicio)} - {formatDate(promo.fecha_fin)}
                  </p>
                </div>

                <div class="mt-auto p-4 bg-white">
                  <a
                    href={`/${currentLang}/promos/${promo.slug}`}
                    class="block w-full text-center px-6 py-3 rounded-full bg-blue hover:bg-blue/90 text-white text-sm font-bold transition"
                  >
                    {labels.viewPromo}
                  </a>
                </div>
              </article>
            ))}
          </div>

          <div class="hidden md:grid mt-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {activePromos.map((promo) => (
              <article class="rounded-[28px] bg-blue text-white shadow-lg overflow-hidden flex flex-col">
                <div class="p-6">
                  <div class="flex items-start justify-between gap-3">
                    <div class="w-16 h-16 rounded-full bg-white/10 overflow-hidden">
                      <LazyImage
                        src={promo.imagen}
                        alt={promo.descripcion}
                        class="w-full h-full object-cover"
                        width={220}
                        height={220}
                      />
                    </div>
                    <span class="px-3 py-1 rounded-full bg-white text-blue text-xs font-bold">
                      {labels.activeBadge}
                    </span>
                  </div>

                  <h3 class="mt-5 font-title text-2xl font-black leading-tight">
                    {promo.descripcion}
                  </h3>
                  <p class="mt-2 text-white/85">
                    <span class="font-bold">{labels.validity}:</span> {formatDate(promo.fecha_inicio)} - {formatDate(promo.fecha_fin)}
                  </p>
                </div>

                <div class="mt-auto p-5 bg-white">
                  <a
                    href={`/${currentLang}/promos/${promo.slug}`}
                    class="block w-full text-center px-6 py-3 rounded-full bg-blue hover:bg-blue/90 text-white font-bold transition"
                  >
                    {labels.viewPromo}
                  </a>
                </div>
              </article>
            ))}
          </div>
        </>
      )}
    </section>

    <section class="mt-14 md:mt-20">
      <div class="flex items-start justify-between gap-6">
        <h2 class="font-title text-[#0b2f87] text-3xl md:text-5xl lg:text-6xl font-black leading-tight whitespace-pre-line">
          {sections.endedTitle}
        </h2>

        <div class="flex gap-2 md:gap-3">
          <button
            type="button"
            class="md:hidden w-9 h-9 rounded-full border border-black/20 bg-primary/60 hover:bg-primary/80 transition flex items-center justify-center"
            aria-label="Previous"
            data-scroll-left="ended"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <button
            type="button"
            class="md:hidden w-9 h-9 rounded-full border border-black/20 bg-primary/60 hover:bg-primary/80 transition flex items-center justify-center"
            aria-label="Next"
            data-scroll-right="ended"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>

      {endedPromos.length === 0 ? (
        <div class="mt-6 rounded-[28px] bg-white/70 border border-black/10 p-8">
          <p class="font-title text-2xl text-[#0b2f87] font-bold">{emptyState.title}</p>
          <p class="mt-2 text-black/70">{emptyState.description}</p>
        </div>
      ) : (
        <>
          <div class="mt-6 md:hidden flex gap-4 overflow-x-auto snap-x snap-mandatory pb-2" data-carousel="ended">
            {endedPromos.map((promo) => (
              <article class="snap-start shrink-0 w-[280px] rounded-[28px] bg-blue text-white shadow-lg overflow-hidden flex flex-col">
                <div class="p-5">
                  <div class="flex items-start justify-between gap-3">
                    <div class="w-14 h-14 rounded-full bg-white/10 overflow-hidden">
                      <LazyImage
                        src={promo.imagen}
                        alt={promo.descripcion}
                        class="w-full h-full object-cover"
                        width={200}
                        height={200}
                      />
                    </div>
                    <span class="px-3 py-1 rounded-full bg-white text-blue text-xs font-bold">
                      {labels.endedBadge}
                    </span>
                  </div>

                  <h3 class="mt-4 font-title text-xl font-black leading-tight">
                    {promo.descripcion}
                  </h3>
                  <p class="mt-2 text-white/85 text-sm">
                    <span class="font-bold">{labels.validity}:</span> {formatDate(promo.fecha_inicio)} - {formatDate(promo.fecha_fin)}
                  </p>
                </div>

                <div class="mt-auto p-4 bg-white">
                  <a
                    href={`/${currentLang}/promos/${promo.slug}`}
                    class="block w-full text-center px-6 py-3 rounded-full bg-blue hover:bg-blue/90 text-white text-sm font-bold transition"
                  >
                    {labels.viewPromo}
                  </a>
                </div>
              </article>
            ))}
          </div>

          <div class="hidden md:grid mt-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {endedPromos.map((promo) => (
              <article class="rounded-[28px] bg-blue text-white shadow-lg overflow-hidden flex flex-col">
                <div class="p-6">
                  <div class="flex items-start justify-between gap-3">
                    <div class="w-16 h-16 rounded-full bg-white/10 overflow-hidden">
                      <LazyImage
                        src={promo.imagen}
                        alt={promo.descripcion}
                        class="w-full h-full object-cover"
                        width={220}
                        height={220}
                      />
                    </div>
                    <span class="px-3 py-1 rounded-full bg-white text-blue text-xs font-bold">
                      {labels.endedBadge}
                    </span>
                  </div>

                  <h3 class="mt-5 font-title text-2xl font-black leading-tight">
                    {promo.descripcion}
                  </h3>
                  <p class="mt-2 text-white/85">
                    <span class="font-bold">{labels.validity}:</span> {formatDate(promo.fecha_inicio)} - {formatDate(promo.fecha_fin)}
                  </p>
                </div>

                <div class="mt-auto p-5 bg-white">
                  <a
                    href={`/${currentLang}/promos/${promo.slug}`}
                    class="block w-full text-center px-6 py-3 rounded-full bg-blue hover:bg-blue/90 text-white font-bold transition"
                  >
                    {labels.viewPromo}
                  </a>
                </div>
              </article>
            ))}
          </div>
        </>
      )}
    </section>

    <section class="mt-14 md:mt-20">
      <div class="rounded-[32px] bg-red text-white overflow-hidden shadow-xl">
        <div class="flex flex-col md:flex-row">
          <div class="w-full md:w-1/2 px-6 md:px-10 py-10 md:py-12 flex flex-col justify-center">
            <h2 class="font-title text-4xl md:text-5xl lg:text-6xl font-black leading-tight whitespace-pre-line">
              {cta.title}
            </h2>
            <p class="mt-4 text-sm md:text-base lg:text-lg max-w-md text-white/90">
              {cta.description}
            </p>
            <div class="mt-6">
              <a
                href={cta.buttonUrl}
                class="inline-block px-8 py-3 rounded-full bg-white text-red font-bold tracking-wide shadow-md hover:shadow-lg transition"
              >
                {cta.buttonText}
              </a>
            </div>
          </div>

          <div class="w-full md:w-1/2 px-6 md:px-10 py-8 md:py-10 flex items-end justify-center md:justify-end">
            <LazyImage
              src={cta.image}
              alt={cta.title}
              class="w-full max-w-[420px] h-auto object-contain"
              width={900}
              height={900}
              loading="lazy"
            />
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  const scrollCarousel = (key: string, direction: number) => {
    const el = document.querySelector(`[data-carousel="${key}"]`);
    if (!el) return;
    const amount = Math.max(240, Math.floor(el.clientWidth * 0.9));
    el.scrollBy({ left: direction * amount, behavior: 'smooth' });
  };

  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement | null;
    if (!target) return;
    const left = target.closest('[data-scroll-left]') as HTMLElement | null;
    const right = target.closest('[data-scroll-right]') as HTMLElement | null;
    if (left) {
      const key = left.getAttribute('data-scroll-left');
      if (key) scrollCarousel(key, -1);
    }
    if (right) {
      const key = right.getAttribute('data-scroll-right');
      if (key) scrollCarousel(key, 1);
    }
  });
</script>
