---
// src/components/Header.astro
import DesktopNavbar from '../DesktopNavbar/index.astro';
import MobileMenuButton from '../MobileMenuButton/index.astro';
import LocalizedImage from '../LazyImage.astro';
import MessageCarousel from '../MessageCarousel/index.astro';
import { t, type Locale } from '../../../i18n/i18n';
import { logos } from '../../../config/assets';
import { getHeaderColors } from '../../../config/headerColors';
import './styles.css';

export interface Props {
  currentLang: Locale;
  headerColors?: {
    backgroundColor?: string;
    textColor?: string;
  };
}

const { currentLang, headerColors } = Astro.props;

// Configuraciones
const logosData = logos;

// Obtener configuración de colores basada en la ruta actual
const { pathname } = Astro.url;
const headerColorConfig = getHeaderColors(pathname);

// Si se pasan colores de header específicos (por ejemplo, desde un producto), 
// crear una configuración personalizada
let customHeaderConfig = headerColorConfig;
let customStyles: { backgroundColor?: string; color?: string } = {};
if (headerColors) {
  customHeaderConfig = {
    ...headerColorConfig,
    // Mantener las clases base pero también usar estilos inline
    backgroundColor: headerColors.backgroundColor ? headerColors.backgroundColor : headerColorConfig.backgroundColor,
    textColor: headerColors.textColor ? headerColors.textColor : headerColorConfig.textColor,
  };
  
  // Crear estilos inline para los colores personalizados
  if (headerColors.backgroundColor) {
    customStyles.backgroundColor = headerColors.backgroundColor;
  }
  if (headerColors.textColor) {
    customStyles.color = headerColors.textColor;
  }
}

const mobileTextColorClass = (customStyles.backgroundColor || '').toLowerCase() === '#fcb800'
  ? 'text-black'
  : customHeaderConfig.textColor;

const mobileHeaderColorConfig = (customStyles.backgroundColor || '').toLowerCase() === '#fcb800'
  ? { ...customHeaderConfig, textColor: 'text-black', hoverTextColor: 'hover:opacity-80', hoverBackgroundColor: 'hover:bg-black/5' }
  : customHeaderConfig;

---

<header 
  id="site-header" 
  class={`relative w-full transition-all duration-300 font-sans flex flex-col ${customHeaderConfig.textColor}`} 
  style={'background-color: ' + (customStyles.backgroundColor || 'transparent') + '; color: ' + (customStyles.color || 'inherit')}
  data-header-config={JSON.stringify(customHeaderConfig)}
>
{headerColorConfig.showMessageCarousel && <MessageCarousel currentLang={currentLang} />}
  
  <!-- Banner superior azul claro con mensaje -->
  <!--{customHeaderConfig.showMessageCarousel && <MessageCarousel currentLang={currentLang} />}
  
  <!-- Navbar principal - ocupa el 100% del ancho -->
  <div 
    class={`w-full ${customHeaderConfig.backgroundColor}`}
    style={customStyles.backgroundColor ? `background-color: ${customStyles.backgroundColor}` : ''}
  >
    <!-- Navbar de Desktop (solo en pantallas lg y superiores) -->
    <div class="hidden lg:block">
      <DesktopNavbar currentLang={currentLang} headerColorConfig={customHeaderConfig} />
    </div>

    <!-- Navegación Móvil -->
    <nav 
      class={`mobile-nav lg:hidden w-full py-2 px-4 grid grid-cols-3 items-center ${mobileTextColorClass}`}
      style={customStyles.backgroundColor ? `background-color: ${customStyles.backgroundColor}` : ''}
    >
      <!-- Mobile Menu Button (Sandwich) -->
      <div class="menu-button-container flex items-center justify-start">
        <MobileMenuButton currentLang={currentLang} headerColorConfig={mobileHeaderColorConfig} />
      </div>

      <!-- Logo para Móvil (Centro) -->
      <div class="logo-container flex items-center justify-center">
        <a href={`/${currentLang}/`} class="flex-shrink-0">
          <LocalizedImage
            src={logosData.principal.url}
            alt={logosData.principal.alt || "Cappy Logo"}
            class="h-12 w-auto object-contain"
            loading="eager"
            width="120"
            height="48"
            priority={true}
          />
        </a>
      </div>

      <!-- Cappy Modal Trigger (Mobile) -->
      <div class="flex items-center justify-end">
        <button
          id="cappyInfoModalOpen-mobile"
          type="button"
          class="cappy-modal-trigger p-0 bg-transparent border-0 cursor-pointer hover:opacity-80 transition-opacity"
          aria-haspopup="dialog"
          aria-controls="cappyInfoModal"
          aria-label={t('cappy_modal.openLabel', { namespace: 'common', locale: currentLang }) || 'Open Cappy info'}
        >
          <LocalizedImage
            src="https://snack.yummiespromociones.com/SnacksyummiesAssets/Gemini_Generated.webp"
            alt={t('cappy_modal.imageAlt', { namespace: 'common', locale: currentLang }) || 'Cappy'}
            class="h-10 w-auto"
            loading="eager"
            width="40"
            height="40"
          />
        </button>
      </div>
    </nav>
  </div>

</header>

<script>
// Función para controlar el comportamiento del header al hacer scroll en desktop
function initHeaderScrollBehavior() {
  const header = document.getElementById('site-header');
  
  function handleScroll() {
    if (!header || window.innerWidth < 1024) return; // Solo aplicar en desktop (lg y superior)
    
    // Obtener la configuración de colores del header
    const headerConfig = header.getAttribute('data-header-config');
    if (headerConfig) {
      const config = JSON.parse(headerConfig);
      
      // Mantener el fondo configurado en desktop
      header.classList.remove('bg-black', 'bg-opacity-90', 'backdrop-blur-md', 'bg-opacity-50', 'bg-transparent', 'bg-blue-900');
      header.classList.add(config.backgroundColor);
    }
  }
  
  window.addEventListener('scroll', handleScroll);
  window.addEventListener('resize', handleScroll);
  
  // Ejecutar una vez al cargar para establecer el estado inicial
  handleScroll();
}

// Ensure the script runs after the DOM is fully loaded
if (typeof window !== 'undefined') {
  if (document.readyState === 'loading') { // Still loading
    document.addEventListener('DOMContentLoaded', initHeaderScrollBehavior);
  } else { // `DOMContentLoaded` has already fired
    initHeaderScrollBehavior();
  }
}

// Reinicializar cuando Astro navega a una nueva página
document.addEventListener('astro:page-load', initHeaderScrollBehavior);
document.addEventListener('astro:after-swap', initHeaderScrollBehavior);
</script>
