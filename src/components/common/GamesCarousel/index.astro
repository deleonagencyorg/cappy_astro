---
// Componente de carrusel de juegos con Swiper
interface Game {
  id: string;
  title: string;
  description: string;
  image: string;
  url: string;
}

export interface Props {
  games: Game[];
  className?: string;
  autoplay?: boolean;
  speed?: number;
  slidesPerView?: number;
  spaceBetween?: number;
  loop?: boolean;
}

const {
  games = [],
  className = '',
  autoplay = true,
  speed = 5000,
  slidesPerView = 3,
  spaceBetween = 30,
  loop = true,
} = Astro.props;

const currentLang = Astro.url.pathname.split('/')[1] === 'es' ? 'es' : 'en';

// Asegurarse de que games es un array
const gamesItems = Array.isArray(games) ? games : [];

const gamesCount = gamesItems.length;
const PLACEHOLDER_IMAGE_URL = 'https://snack.yummiespromociones.com/snacksyummies/placeholder.webp';

import LazyImage from '../LazyImage.astro';
---

<div class={`games-carousel ${className}`} data-autoplay={autoplay} data-speed={speed}>
  
  <div class="swiper-container">
    <div class="swiper-wrapper">
      {gamesCount === 0 ? (
        <div class="swiper-slide">
          <div class="game-card-cta">
            <div class="game-card">
              <div class="game-background"></div>
              <div class="game-image-container">
                <LazyImage 
                  src={PLACEHOLDER_IMAGE_URL}
                  alt="Cappy"
                  class="game-image"
                  width={300}
                  height={400}
                />
              </div>
            </div>
            <div class="game-info">
              <h3 class="game-title">&nbsp;</h3>
            </div>
          </div>
        </div>
      ) : (
        gamesItems.map((game) => (
          <div class="swiper-slide">
            <a 
              href={game.url}
              class="game-card-cta"
              target="_blank"
              rel="noopener noreferrer"
            >
              <div class="game-card">
                <div class="game-background"></div>
                <div class="game-image-container">
                  <LazyImage 
                    src={game.image} 
                    alt={game.title}
                    class="game-image"
                    width={300}
                    height={400}
                  />
                </div>
              </div>
              <div class="game-info">
                <h3 class="game-title">{game.title}</h3>
                {game.description && (
                  <p class="game-description">{game.description}</p>
                )}
              </div>
            </a>
          </div>
        ))
      )}
    </div>
    
    <!-- Navegación -->
    {gamesCount > 1 && (
      <div class="carousel-controls">
        <button class="carousel-control swiper-button-prev" type="button"></button>
        <button class="carousel-control swiper-button-next" type="button"></button>
      </div>
    )}
  </div>
</div>

<style>
  .games-carousel {
    width: 100%;
    padding: 1rem 0;
    overflow: visible;
    padding-top: 120px;
  }

  .swiper-container {
    position: relative;
    width: 100%;
    padding: 0 40px;
    overflow: visible;
  }

  .swiper-wrapper {
    display: flex;
    align-items: stretch;
    overflow: visible;
  }

  .swiper-slide {
    height: auto;
    display: flex;
    justify-content: center;
    flex-shrink: 0;
    width: auto;
    overflow: visible;
  }

  .game-card-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    transition: transform 0.2s ease;
  }

  .game-card-cta:hover {
    transform: translateY(-4px);
  }

  .game-card {
    position: relative;
    width: 240px;
    aspect-ratio: 3 / 4;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .game-background {
    position: absolute;
    inset: 12%;
    border-radius: 32px;
    background-color: #f5d000;
  }

  .game-image-container {
    position: relative;
    z-index: 2;
  }

  .game-image-container .game-image {
    width: 220px;
    height: auto;
    object-fit: contain;
    display: block;
  }

  .game-info {
    text-align: center;
    width: 100%;
    max-width: 240px;
  }

  .game-title {
    font-size: 1rem;
    font-weight: 700;
    color: #004AB2;
    margin-bottom: 0.25rem;
  }

  .game-description {
    font-size: 0.85rem;
    color: #333;
    line-height: 1.3;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .games-carousel {
      padding-top: 100px;
    }
    
    .swiper-container {
      padding: 0 24px;
    }

    .game-card {
      width: 210px;
    }

    .game-info {
      max-width: 210px;
    }

    .game-title {
      font-size: 0.95rem;
    }

    .game-description {
      font-size: 0.8rem;
    }
  }

  @media (max-width: 480px) {
    .games-carousel {
      padding-top: 80px;
    }
    
    .swiper-container {
      padding: 0 16px;
    }

    .game-card {
      width: 190px;
    }

    .game-image-container .game-image {
      width: 180px;
    }

    .game-info {
      max-width: 190px;
    }

    .game-title {
      font-size: 0.9rem;
    }

    .game-description {
      font-size: 0.75rem;
    }
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';

  interface GamesCarouselOptions {
    autoplay?: boolean;
    speed?: number;
    slidesPerView?: number;
    spaceBetween?: number;
    loop?: boolean;
  }

  class GamesCarousel {
    private container: HTMLElement;
    private swiper: Swiper | null = null;
    private options: GamesCarouselOptions;

    constructor(container: HTMLElement, options: GamesCarouselOptions = {}) {
      this.container = container;
      this.options = options;
      this.init();
    }

    private init(): void {
      const swiperContainer = this.container.querySelector('.swiper-container') as HTMLElement;
      
      if (!swiperContainer) return;

      const slidesCount = swiperContainer.querySelectorAll('.swiper-slide').length;
      if (slidesCount <= 1) return;

      this.swiper = new Swiper(swiperContainer, {
        modules: [Navigation, Autoplay],
        slidesPerView: this.options.slidesPerView || 3,
        spaceBetween: this.options.spaceBetween || 30,
        loop: this.options.loop !== false,
        autoplay: this.options.autoplay ? {
          delay: this.options.speed || 5000,
          disableOnInteraction: false,
        } : false,
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
        breakpoints: {
          320: {
            slidesPerView: 1,
            spaceBetween: 20,
          },
          768: {
            slidesPerView: 2,
            spaceBetween: 30,
          },
          1024: {
            slidesPerView: this.options.slidesPerView || 3,
            spaceBetween: this.options.spaceBetween || 30,
          },
        },
      });
    }

    public destroy(): void {
      if (this.swiper) {
        this.swiper.destroy();
        this.swiper = null;
      }
    }
  }

  // Variable global para almacenar instancias
  let carouselInstances: GamesCarousel[] = [];

  // Función para limpiar instancias existentes
  function cleanupCarousels() {
    carouselInstances.forEach(instance => instance.destroy());
    carouselInstances = [];
  }

  // Función para inicializar carruseles
  function initializeCarousels() {
    cleanupCarousels();
    
    const carousels = document.querySelectorAll('.games-carousel');
    carousels.forEach((element: Element) => {
      if (element instanceof HTMLElement) {
        const instance = new GamesCarousel(element, {
          autoplay: element.dataset.autoplay !== 'false',
          speed: parseInt(element.dataset.speed || '5000', 10),
          slidesPerView: 3,
          spaceBetween: 30,
          loop: true,
        });
        carouselInstances.push(instance);
      }
    });
  }

  // Inicializar en DOMContentLoaded
  document.addEventListener('DOMContentLoaded', initializeCarousels);
  // Reinicializar en navegaciones parciales
  document.addEventListener('astro:page-load', initializeCarousels);
  document.addEventListener('astro:after-swap', initializeCarousels);
  // Limpiar antes del swap de Astro
  document.addEventListener('astro:before-swap', cleanupCarousels);
</script>
