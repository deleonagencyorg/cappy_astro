---
import { Image } from 'astro:assets';
import HeroBanner from '../HeroBanner.astro';
import LazyImage from '../LazyImage.astro';

interface SlideItem {
  type: 'image' | 'video' | 'html';
  desktop?: string;
  mobile?: string;
  alt?: string;
  title?: string;
  subtitle?: string;
  description?: string;
  link?: string;
  html?: {
    backgroundImage: string;
    backgroundImageMobile?: string;
    image: string;
    imageMobile?: string;
    title: string;
    subtitle?: string;
    description?: string;
    buttonText?: string;
    buttonUrl?: string;
  };
}

interface Props {
  slides: SlideItem[];
  height?: string;
  mobileHeight?: string;
  overlayOpacity?: string;
  textColor?: string;
  showOverlay?: boolean;
  width?: string;
  borderRadius?: string;
  containerClass?: string;
}

const {
  slides = [],
  height = "100vh",
  mobileHeight = "300px",
  overlayOpacity = "50",
  textColor = "text-white",
  showOverlay = true,
  width = "100%",
  borderRadius = "0",
  containerClass = ""
} = Astro.props;

const firstSlide = slides[0] || {};
---

<div class="video-carousel-container" style={`width: ${width}; margin: 0 auto; --desktop-height: ${height}; --mobile-height: ${mobileHeight};`}>
  <!-- Swiper container -->
  <div class="swiper-container video-carousel" style={`border-radius: ${borderRadius}; overflow: hidden;`}>
    <div class="swiper-wrapper">
      {slides.map((slide, index) => {
        const slideId = `slide-${index}`;
        
        return (
          <div class="swiper-slide" id={slideId} data-slide-type={slide.type}>
            <div class="slide-content">
              {slide.type === 'html' && slide.html ? (
                <HeroBanner 
                  backgroundImage={slide.html.backgroundImage}
                  backgroundImageMobile={slide.html.backgroundImageMobile}
                  image={slide.html.image}
                  imageMobile={slide.html.imageMobile}
                  title={slide.html.title}
                  subtitle={slide.html.subtitle}
                  description={slide.html.description}
                  buttonText={slide.html.buttonText}
                  buttonUrl={slide.html.buttonUrl}
                />
              ) : slide.type === 'video' ? (
                <>
                  <div class="fallback-image">
                    <LazyImage 
                      src={slide.desktop?.replace(/\.(mp4|webm)$/i, '.jpg') || ''} 
                      alt={slide.alt || "Slide background"} 
                      width="1920" 
                      height="1080"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>
                  <div class="video-container">
                    <video 
                      autoplay 
                      muted 
                      loop 
                      playsinline
                      class="slide-video"
                      data-slide-id={slideId}
                      preload={index === 0 ? "auto" : "metadata"}
                    >
                      <source src={slide.desktop} type={slide.desktop?.toLowerCase().endsWith('.webm') ? 'video/webm' : 'video/mp4'}>
                      Your browser does not support the video tag.
                    </video>
                  </div>
                  {showOverlay && (slide.title || slide.subtitle) && (
                    <div class={`overlay bg-black bg-opacity-${overlayOpacity}`}>
                      <div class="text-content">
                        {slide.title && <h1 class={`slide-title ${textColor}`}>{slide.title}</h1>}
                        {slide.subtitle && <p class={`slide-subtitle ${textColor}`}>{slide.subtitle}</p>}
                        {slide.link && (
                          <a href={slide.link} class="slide-link">
                            <span>Ver más</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <line x1="5" y1="12" x2="19" y2="12"></line>
                              <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                          </a>
                        )}
                      </div>
                    </div>
                  )}
                </>
              ) : (
                <>
                  <div class="image-container">
                    <LazyImage 
                      src={slide.desktop || ''} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image desktop-image"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                    <LazyImage 
                      src={slide.mobile || slide.desktop || ''} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image mobile-image"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>
                  {showOverlay && (slide.title || slide.subtitle) && (
                    <div class={`overlay bg-black bg-opacity-${overlayOpacity}`}>
                      <div class="text-content">
                        {slide.title && <h1 class={`slide-title ${textColor}`}>{slide.title}</h1>}
                        {slide.subtitle && <p class={`slide-subtitle ${textColor}`}>{slide.subtitle}</p>}
                        {slide.link && (
                          <a href={slide.link} class="slide-link">
                            <span>Ver más</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <line x1="5" y1="12" x2="19" y2="12"></line>
                              <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                          </a>
                        )}
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>
        );
      })}
    </div>
    
    <!-- Navigation controls -->
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>

<style>
  /* Estilos para flechas y puntos de navegación blancos */
  :global(.swiper-button-next),
  :global(.swiper-button-prev) {
    color: white !important;
    filter: drop-shadow(0px 0px 3px rgba(0, 0, 0, 0.5));
  }
  
  :global(.swiper-pagination-bullet) {
    background: white !important;
    opacity: 0.7;
  }
  
  :global(.swiper-pagination-bullet-active) {
    opacity: 1;
    background: white !important;
  }
  
  .video-carousel-container {
    position: relative;
    overflow: visible;
  }
  
  .slide-content {
    position: relative;
    width: 100%;
    overflow: hidden;
    height: var(--desktop-height);
  }
  
  .swiper-container {
    overflow: hidden;
  }
  
  @media (max-width: 767px) {
    .slide-content {
      height: var(--mobile-height) !important;
    }
  }
  
  .fallback-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }
  
  .fallback-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .video-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
  }
  
  .slide-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .image-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
  }
  
  .slide-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }
  
  .desktop-image {
    display: none;
  }
  
  .mobile-image {
    display: block;
  }
  
  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 3;
  }
  
  .text-content {
    text-align: center;
    padding: 0 1rem;
    max-width: 800px;
  }
  
  .slide-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }
  
  .slide-subtitle {
    font-size: 1.5rem;
    font-weight: 400;
    margin-bottom: 2rem;
  }
  
  .slide-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 9999px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .slide-link:hover {
    background-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }
  
  /* Responsive styles */
  @media (min-width: 768px) {
    .desktop-image {
      display: block;
    }
    
    .mobile-image {
      display: none;
    }
    
    .slide-title {
      font-size: 3.5rem;
    }
    
    .slide-subtitle {
      font-size: 2rem;
    }
  }
  
  .html-slide-active .slide-content {
    animation: htmlSlideFadeIn 260ms ease both;
  }

  @keyframes htmlSlideFadeIn {
    0% {
      opacity: 0;
    }
    100% {
      opacity: 1;
    }
  }
  
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/pagination';

  let videoCarouselInstances: Swiper[] = [];

  function cleanupVideoCarousels() {
    videoCarouselInstances.forEach((instance) => {
      try {
        instance?.destroy?.(true, true);
      } catch (e) {
      }
    });
    videoCarouselInstances = [];
  }

  function initializeVideoCarousels() {
    cleanupVideoCarousels();

    const containers = document.querySelectorAll('.swiper-container.video-carousel');
    containers.forEach((containerEl) => {
      if (!(containerEl instanceof HTMLElement)) return;
      const container = containerEl;

      const nextEl = container.querySelector('.swiper-button-next');
      const prevEl = container.querySelector('.swiper-button-prev');
      const paginationEl = container.querySelector('.swiper-pagination');

      const swiper = new Swiper(container, {
        modules: [Navigation, Pagination, Autoplay],
        slidesPerView: 1,
        spaceBetween: 0,
        loop: true,
        autoplay: {
          delay: 5000,
          disableOnInteraction: false,
        },
        navigation: {
          nextEl: nextEl instanceof HTMLElement ? nextEl : undefined,
          prevEl: prevEl instanceof HTMLElement ? prevEl : undefined,
        },
        pagination: {
          el: paginationEl instanceof HTMLElement ? paginationEl : undefined,
          clickable: true,
        },
      });

      videoCarouselInstances.push(swiper);

      function updateHtmlSlideAnimation() {
        const allSlides = swiper.slides || [];
        allSlides.forEach((slideEl) => {
          if (slideEl.classList) {
            slideEl.classList.remove('html-slide-active');
          }
        });

        const activeSlide = swiper.slides[swiper.activeIndex];
        if (activeSlide && activeSlide.getAttribute('data-slide-type') === 'html') {
          activeSlide.classList.add('html-slide-active');
        }
      }

      function playVideo(video) {
        if (!video) return;

        const playPromise = video.play();

        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              const slideId = video.getAttribute('data-slide-id');
              const fallbackImage = container.querySelector(`#${slideId} .fallback-image`);
              if (fallbackImage) {
                fallbackImage.style.opacity = '0';
              }
            })
            .catch(() => {
            });
        }
      }

      function pauseAllVideos() {
        const videos = container.querySelectorAll('.slide-video');
        videos.forEach((video) => {
          video.pause();
        });
      }

      swiper.on('slideChange', () => {
        pauseAllVideos();

        const activeSlide = swiper.slides[swiper.activeIndex];
        const activeVideo = activeSlide?.querySelector('.slide-video');

        if (activeVideo) {
          setTimeout(() => playVideo(activeVideo), 300);
        }

        updateHtmlSlideAnimation();
      });

      const initialVideo = swiper.slides[swiper.activeIndex]?.querySelector('.slide-video');
      if (initialVideo) {
        playVideo(initialVideo);
      }

      updateHtmlSlideAnimation();

      const videos = container.querySelectorAll('.slide-video');
      videos.forEach((video) => {
        const slideId = video.getAttribute('data-slide-id');
        const fallbackImage = container.querySelector(`#${slideId} .fallback-image`);

        video.addEventListener('canplay', () => {
          if (fallbackImage) {
            fallbackImage.style.opacity = '0';
          }
        });

        video.addEventListener('error', () => {
          if (fallbackImage) {
            fallbackImage.style.opacity = '1';
          }
        });
      });
    });
  }

  document.addEventListener('DOMContentLoaded', initializeVideoCarousels);
  document.addEventListener('astro:page-load', initializeVideoCarousels);
  document.addEventListener('astro:after-swap', initializeVideoCarousels);
  document.addEventListener('astro:before-swap', cleanupVideoCarousels);
</script>
