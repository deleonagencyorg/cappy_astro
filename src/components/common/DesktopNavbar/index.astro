---
import LanguageSwitcher from '../../i18n/LanguageSwitcher.astro';
import { t, type Locale } from '../../../i18n/i18n';
import { logos } from '../../../config/assets';
import type { HeaderColorConfig } from '../../../config/headerColors';
import LazyImage from '../LazyImage.astro';

export interface Props {
  currentLang: Locale;
  headerColorConfig: HeaderColorConfig;
}

const { currentLang, headerColorConfig } = Astro.props;

// Get current path to determine active menu item
const { pathname } = Astro.url;
const currentPath = pathname;

// Obtener los datos de social media y menú desde las traducciones
const menuItems = t('menu_items', { namespace: 'common', locale: currentLang }) as any[];
const cappyModal = t('cappy_modal', { namespace: 'common', locale: currentLang }) as any;
const socialMediaObj = t('social_media', { namespace: 'common', locale: currentLang });
const socialMedia = socialMediaObj ? Object.values(socialMediaObj) : [];

const leftMenuItems = Array.isArray(menuItems) ? menuItems.slice(0, 2) : [];
const rightMenuItems = Array.isArray(menuItems) ? menuItems.slice(2) : [];
---

<!-- Desktop Navigation -->
<nav class={`hidden md:grid grid-cols-3 items-center w-full py-3 px-6 ${headerColorConfig.backgroundColor}`} data-current-lang={currentLang}>
  <!-- Left menu -->
  <div class="flex items-center justify-start gap-8" id="desktop-menu-left">
    {currentLang === 'es' && (
      <a
        href="https://backtoschool.yummiespromociones.com/"
        id="back-to-school-btn"
        class="font-title text-xl uppercase font-medium py-2 px-3 rounded-md bg-[#E30613] text-white hover:opacity-90 transition-colors"
        data-preserve-utm="true"
      >
        Back to School
      </a>
    )}
    {leftMenuItems.map((item: any) => (
      <div class="relative group">
        <a
          href={item.href}
          class={`font-title text-xl uppercase font-medium transition-colors py-2 px-1 rounded-md flex items-center ${headerColorConfig.textColor} ${headerColorConfig.hoverTextColor} ${!item.href.startsWith('#') && currentPath === item.href ? 'opacity-80' : ''}`}
        >
          {item.text}
        </a>
      </div>
    ))}
  </div>

  <!-- Center logo -->
  <div class="flex items-center justify-center">
    <a href={`/${currentLang}/`} class="block">
      <img src={logos.principal.url} alt={logos.principal.alt} class="h-20 w-auto" />
    </a>
  </div>

  <!-- Right menu + controls -->
  <div class="flex items-center justify-end gap-6">
    <div class="flex items-center gap-8" id="desktop-menu-right">
      {rightMenuItems.map((item: any) => (
        <div class="relative group">
          <a 
            href={item.href} 
            class={`font-title text-xl uppercase font-medium transition-colors py-2 px-1 rounded-md flex items-center ${headerColorConfig.textColor} ${headerColorConfig.hoverTextColor} ${!item.href.startsWith('#') && currentPath === item.href ? 'opacity-80' : ''}`}
          >
            {item.text}
            {item.submenu && (
              <svg class="w-4 h-4 ml-1 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" /></svg>
            )}
          </a>
          {item.submenu && (
            <div class="absolute left-0 mt-0 w-48 bg-white text-gray-800 rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 ease-in-out invisible group-hover:visible z-50 py-1">
              {item.submenu.map((subItem: any) => (
                <div class="relative group/submenu">
                  <a href={subItem.href} class="px-4 py-2 text-sm font-sans hover:bg-quinary flex justify-between items-center transition-colors duration-200 ${!subItem.href.startsWith('#') && currentPath === subItem.href ? 'bg-quinary' : ''}">
                    {subItem.text}
                    {subItem.submenu && (
                      <svg class="w-3 h-3 ml-1 fill-current" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 01-1.414 0z" /></svg>
                    )}
                  </a>
                  {subItem.submenu && (
                    <div class="absolute left-full top-0 w-48 bg-white text-gray-800 rounded-md shadow-lg opacity-0 group-hover/submenu:opacity-100 transition-opacity duration-200 ease-in-out invisible group-hover/submenu:visible z-50 py-1">
                      {subItem.submenu.map((thirdItem: any) => (
                        <a href={thirdItem.href} class="block px-4 py-2 text-sm font-sans hover:bg-quinary transition-colors duration-200 ${!thirdItem.href.startsWith('#') && currentPath === thirdItem.href ? 'bg-quinary' : ''}">{thirdItem.text}</a>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
    <button
      id="cappyInfoModalOpen"
      type="button"
      class="cappy-modal-trigger p-0 bg-transparent border-0 cursor-pointer hover:opacity-80 transition-opacity"
      aria-haspopup="dialog"
      aria-controls="cappyInfoModal"
      aria-label={cappyModal?.openLabel || 'Open Cappy info'}
    >
      <LazyImage src="https://snack.yummiespromociones.com/SnacksyummiesAssets/Gemini_Generated.webp" alt={logos.principal.alt} class="h-10 w-auto" />
    </button>
    <!-- Social Media Icons -->
    <div class="flex items-center gap-3">
      {socialMedia.map((sm: any) => (
        <a 
          href={sm.url} 
          target="_blank" 
          rel="noopener noreferrer" 
          title={sm.name}
          class="hover:opacity-80 transition-opacity"
        >
          <svg class="w-5 h-5 fill-[#E30613]" viewBox="0 0 24 24">
            {sm.name === 'Facebook' && (
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            )}
            {sm.name === 'Instagram' && (
              <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/>
            )}
            {sm.name === 'TikTok' && (
              <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
            )}
          </svg>
        </a>
      ))}
    </div>
    <!-- Language Switcher -->
    <LanguageSwitcher activeLocale={currentLang} headerColorConfig={headerColorConfig} />
  </div>
</nav>

<script>
  // Preservar UTMs en el botón Back to School
  document.addEventListener('DOMContentLoaded', () => {
    const backToSchoolBtn = document.getElementById('back-to-school-btn');
    if (backToSchoolBtn && backToSchoolBtn.dataset.preserveUtm === 'true') {
      backToSchoolBtn.addEventListener('click', (e) => {
        const currentUrl = new URL(window.location.href);
        const searchParams = currentUrl.searchParams;
        
        // Si hay parámetros UTM, agregarlos a la URL de destino
        if (searchParams.toString()) {
          const hasUtm = Array.from(searchParams.keys()).some(key => key.startsWith('utm_'));
          
          if (hasUtm) {
            e.preventDefault();
            const baseUrl = backToSchoolBtn.getAttribute('href') || 'https://backtoschool.yummiespromociones.com/';
            const destination = baseUrl + '?' + searchParams.toString();
            
            // Enviar evento a GTM si está disponible
            if (typeof window !== 'undefined' && (window as any).dataLayer) {
              (window as any).dataLayer.push({
                event: 'backtoschool_header_click',
                destination: destination,
                utm_source: searchParams.get('utm_source') || '',
                utm_medium: searchParams.get('utm_medium') || '',
                utm_campaign: searchParams.get('utm_campaign') || '',
              });
            }
            
            window.location.href = destination;
          }
        }
      });
    }
  });
</script>
