---
// Componente de carrusel de productos con Swiper
interface Product {
  id: string;
  slug: string;
  name: string;
  image: string;
  imageMobile?: string;
  background_image?: string;
  background_color?: string;
  text_color?: string;
}

export interface Props {
  products: Product[];
  className?: string;
  autoplay?: boolean;
  speed?: number;
  slidesPerView?: number;
  spaceBetween?: number;
  loop?: boolean;
  color?: string;
  cardBackgroundImage?: string;
  paddingTop?: string;
  mobilePaddingTop?: string;
}

const {
  products = [],
  className = '',
  autoplay = true,
  speed = 5000,
  slidesPerView = 3,
  spaceBetween = 30,
  loop = true,
  color = '#F08C00',
  cardBackgroundImage = '',
  paddingTop = '120px',
  mobilePaddingTop = '80px'
} = Astro.props;

const DEFAULT_CARD_BACKGROUND_IMAGE = 'https://snack.yummiespromociones.com/SnacksyummiesAssets/bgcardcappy.webp';

const currentLang = Astro.url.pathname.split('/')[1] === 'es' ? 'es' : 'en';

// Textos según idioma
const texts = {
  es: {
    viewMore: 'Ver más'
  },
  en: {
    viewMore: 'View more'
  }
};

const currentTexts = texts[currentLang as keyof typeof texts];

// Asegurarse de que products es un array
const productsItems = Array.isArray(products) ? products : [];

const productsCount = productsItems.length;
const PLACEHOLDER_IMAGE_URL = 'https://snack.yummiespromociones.com/snacksyummies/placeholder.webp';

import LazyImage from '../LazyImage.astro';
---

<div
  class={`products-carousel ${className}`}
  data-autoplay={autoplay}
  data-speed={speed}
  data-slides-per-view={slidesPerView}
  data-space-between={spaceBetween}
  style={{
    '--pc-padding-top': paddingTop,
    '--pc-padding-top-mobile': mobilePaddingTop,
  }}
>
  
  <div class="swiper-container">
    <div class="swiper-wrapper">
      {productsCount === 0 ? (
        <div class="swiper-slide">
          <div class="product-card-cta">
            <div class="product-card">
              <div
                class="product-background"
                style={{
                  '--default-bg': `url(${cardBackgroundImage || DEFAULT_CARD_BACKGROUND_IMAGE})`,
                  '--hover-bg': `url(${cardBackgroundImage || DEFAULT_CARD_BACKGROUND_IMAGE})`,
                  backgroundImage: 'var(--default-bg)',
                }}
              ></div>
              <div class="product-image-container">
                <LazyImage 
                  src={PLACEHOLDER_IMAGE_URL}
                  alt="Cappy"
                  class="product-image"
                  width={300}
                  height={400}
                />
              </div>
            </div>
            <p class="product-title">&nbsp;</p>
          </div>
        </div>
      ) : (
        productsItems.map((product) => (
          <div class="swiper-slide">
            <a 
              href={`/${currentLang}/${currentLang === 'es' ? 'productos' : 'products'}/${product.slug}`}
              class="product-card-cta"
            >
              <div class="product-card">
                <div
                  class="product-background"
                  style={{
                    '--default-bg': `url(${cardBackgroundImage || DEFAULT_CARD_BACKGROUND_IMAGE})`,
                    '--hover-bg': `url(${product.background_image || cardBackgroundImage || DEFAULT_CARD_BACKGROUND_IMAGE})`,
                    backgroundImage: 'var(--default-bg)',
                  }}
                ></div>
                <div class="product-image-container">
                  <LazyImage 
                    src={product.imageMobile || product.image} 
                    alt={product.name}
                    class="product-image"
                    width={300}
                    height={400}
                  />
                </div>
              </div>
              <p class="product-title">
                {product.name}
              </p>
            </a>
          </div>
        ))
      )}
    </div>
  </div>

  <!-- Navegación -->
  {productsCount > 1 && (
    <div class="carousel-controls">
      <button class="carousel-control swiper-button-prev" type="button"></button>
      <button class="carousel-control swiper-button-next" type="button"></button>
    </div>
  )}
</div>

<style>
  .products-carousel {
    width: 100%;
    padding: 1rem 0;
    overflow: visible;
    padding-top: var(--pc-padding-top, 120px);
  }

  .swiper-container {
    position: relative;
    width: 100%;
    max-width: 100%;
    padding: 0 40px;
    overflow: visible;
    margin: 0 auto;
  }

  .swiper-wrapper {
    display: flex;
    align-items: stretch;
    overflow: visible;
  }

  .swiper-slide {
    height: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    overflow: visible;
  }

  /* Mobile: use native scroll-snap instead of Swiper */
  @media (max-width: 767px) {
    .swiper-container {
      padding: 0;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
    }

    .swiper-container::-webkit-scrollbar {
      display: none; /* Chrome, Safari */
    }

    .swiper-wrapper {
      display: flex;
      flex-wrap: nowrap;
      gap: 0;
    }

    .swiper-slide {
      flex: 0 0 100%;
      width: 100%;
      scroll-snap-align: center;
      scroll-snap-stop: always;
    }
  }

  .product-card-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
  }

  .product-card {
    position: relative;
    width: 260px;
    aspect-ratio: 3 / 4;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
  }

  .product-background {
    position: absolute;
    inset: 8%;
    border-radius: 32px;
    background-color: #f5d000; /* fallback */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: opacity 220ms ease;
  }

  .product-background::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background-image: var(--hover-bg);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0;
    transition: opacity 220ms ease;
  }

  @media (hover: hover) {
    .product-card-cta:hover .product-background::after,
    .product-card-cta:focus-visible .product-background::after {
      opacity: 1;
    }

    .product-card-cta:hover .product-card,
    .product-card-cta:focus-visible .product-card {
      animation: cappyHoverBounce 420ms cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }
  }

  @keyframes cappyHoverBounce {
    0% {
      transform: translateY(0) scale(1);
    }
    55% {
      transform: translateY(-6px) scale(1.02);
    }
    100% {
      transform: translateY(0) scale(1);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .product-background,
    .product-background::after {
      transition: none;
    }
    .product-card-cta:hover .product-card,
    .product-card-cta:focus-visible .product-card {
      animation: none;
    }
  }

  .product-image-container {
    position: relative;
    z-index: 2;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10%;
  }

  .product-image-container .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .product-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #004AB2; /* azul de Cappy */
    text-align: left;
    width: 100%;
    max-width: 260px;
  }

  /* Mobile: card sizing */
  @media (max-width: 767px) {
    .products-carousel {
      padding-top: var(--pc-padding-top-mobile, 80px);
    }

    .product-card {
      width: min(320px, 85vw);
      margin: 0 auto;
    }

    .product-title {
      max-width: min(320px, 85vw);
      text-align: center;
      font-size: 1rem;
    }

    /* Show navigation controls on mobile */
    .carousel-controls {
      display: flex;
      justify-content: flex-start;
      gap: 0.5rem;
      margin-top: 1rem;
      padding: 0 1rem;
    }
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';

  interface ProductsCarouselOptions {
    autoplay?: boolean;
    speed?: number;
    slidesPerView?: number;
    spaceBetween?: number;
    loop?: boolean;
  }

  class ProductsCarousel {
    private container: HTMLElement;
    private swiper: Swiper | null = null;
    private options: ProductsCarouselOptions;

    constructor(container: HTMLElement, options: ProductsCarouselOptions = {}) {
      this.container = container;
      this.options = options;
      this.init();
    }

    private init(): void {
      const swiperContainer = this.container.querySelector('.swiper-container') as HTMLElement;
      
      if (!swiperContainer) return;

      const slidesCount = swiperContainer.querySelectorAll('.swiper-slide').length;
      if (slidesCount <= 1) return;

      const prevBtn = this.container.querySelector('.swiper-button-prev') as HTMLElement | null;
      const nextBtn = this.container.querySelector('.swiper-button-next') as HTMLElement | null;

      // Add event listeners to prevent swiper from handling link clicks
      const productLinks = swiperContainer.querySelectorAll('a[data-no-swipe]');
      productLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          // Stop propagation to prevent Swiper from handling the click
          e.stopPropagation();
        });
      });

      // Read dataset overrides
      const ds = this.container.dataset as any;
      const dsSlides = parseInt(ds.slidesPerView || '3', 10);
      const dsSpace = parseInt(ds.spaceBetween || '30', 10);

      const isMobile = window.matchMedia('(max-width: 767px)').matches;

      // On mobile, use native scroll-snap with manual navigation buttons
      if (isMobile) {
        this.initMobileNavigation(swiperContainer, prevBtn, nextBtn);
        return;
      }

      this.swiper = new Swiper(swiperContainer, {
        modules: [Navigation, Autoplay],
        slidesPerView: dsSlides || this.options.slidesPerView || 3,
        spaceBetween: dsSpace || this.options.spaceBetween || 30,
        loop: this.options.loop !== false,
        roundLengths: true,
        watchOverflow: true,
        slideToClickedSlide: false,
        centeredSlides: true,
        centeredSlidesBounds: true,
        autoplay: this.options.autoplay ? {
          delay: this.options.speed || 5000,
          disableOnInteraction: false,
        } : false,
        navigation: {
          nextEl: nextBtn,
          prevEl: prevBtn,
        },
        // Prevent swiper from handling clicks on links with data-no-animation
        preventClicksPropagation: true,
        preventClicks: false,
        noSwiping: true,
        noSwipingClass: 'swiper-no-swiping',
      });

      // Add swiper-no-swiping class to all links with data-no-swipe attribute
      productLinks.forEach(link => {
        link.classList.add('swiper-no-swiping');
      });
    }

    private initMobileNavigation(
      container: HTMLElement,
      prevBtn: HTMLElement | null,
      nextBtn: HTMLElement | null,
    ): void {
      const scroller = container;
      const slides = container.querySelectorAll('.swiper-slide');
      
      if (slides.length <= 1) return;

      let currentIndex = 0;

      // Always reset on init to avoid carrying scroll position between Astro swaps
      scroller.scrollLeft = 0;

      const scrollToIndex = (index: number) => {
        if (index < 0) index = 0;
        if (index >= slides.length) index = slides.length - 1;
        currentIndex = index;
        const w = scroller.clientWidth || 1;
        const MOBILE_CENTER_NUDGE_PX = 20;
        const targetLeft = Math.round(index * w + MOBILE_CENTER_NUDGE_PX);
        requestAnimationFrame(() => {
          scroller.scrollTo({
            left: targetLeft,
            behavior: 'smooth'
          });
        });
      };

      const updateIndexFromScroll = () => {
        const w = scroller.clientWidth || 1;
        currentIndex = Math.round(scroller.scrollLeft / w);
      };

      prevBtn?.addEventListener('click', () => scrollToIndex(currentIndex - 1));
      nextBtn?.addEventListener('click', () => scrollToIndex(currentIndex + 1));

      scroller.addEventListener('scroll', updateIndexFromScroll, { passive: true });
    }

    public destroy(): void {
      if (this.swiper) {
        this.swiper.destroy();
        this.swiper = null;
      }
    }
  }

  // Variable global para almacenar instancias
  let carouselInstances: ProductsCarousel[] = [];

  // Función para limpiar instancias existentes
  function cleanupCarousels() {
    carouselInstances.forEach(instance => instance.destroy());
    carouselInstances = [];
  }

  // Función para inicializar carruseles
  function initializeCarousels() {
    cleanupCarousels();
    
    const carousels = document.querySelectorAll('.products-carousel');
    carousels.forEach((element: Element) => {
      if (element instanceof HTMLElement) {
        const instance = new ProductsCarousel(element, {
          autoplay: element.dataset.autoplay !== 'false',
          speed: parseInt(element.dataset.speed || '5000', 10),
          slidesPerView: 3,
          spaceBetween: 30,
          loop: true,
        });
        carouselInstances.push(instance);
      }
    });
  }

  // Inicializar en DOMContentLoaded
  document.addEventListener('DOMContentLoaded', initializeCarousels);
  // Reinicializar en navegaciones parciales
  document.addEventListener('astro:page-load', initializeCarousels);
  document.addEventListener('astro:after-swap', initializeCarousels);
  // Limpiar antes del swap de Astro
  document.addEventListener('astro:before-swap', cleanupCarousels);
</script> 