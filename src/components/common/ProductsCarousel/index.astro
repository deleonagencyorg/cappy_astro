---
// Componente de carrusel de productos con Swiper
interface Product {
  id: string;
  slug: string;
  name: string;
  image: string;
  imageMobile?: string;
  background_image?: string;
  background_color?: string;
  text_color?: string;
}

export interface Props {
  products: Product[];
  className?: string;
  autoplay?: boolean;
  speed?: number;
  slidesPerView?: number;
  spaceBetween?: number;
  loop?: boolean;
  color?: string;
  cardBackgroundImage?: string;
  paddingTop?: string;
  mobilePaddingTop?: string;
}

const {
  products = [],
  className = '',
  autoplay = true,
  speed = 5000,
  slidesPerView = 3,
  spaceBetween = 30,
  loop = true,
  color = '#F08C00',
  cardBackgroundImage = '',
  paddingTop = '120px',
  mobilePaddingTop = '80px'
} = Astro.props;

const DEFAULT_CARD_BACKGROUND_IMAGE = 'https://snack.yummiespromociones.com/SnacksyummiesAssets/bgcardcappy.webp';

const currentLang = Astro.url.pathname.split('/')[1] === 'es' ? 'es' : 'en';

// Textos según idioma
const texts = {
  es: {
    viewMore: 'Ver más'
  },
  en: {
    viewMore: 'View more'
  }
};

const currentTexts = texts[currentLang as keyof typeof texts];

// Asegurarse de que products es un array
const productsItems = Array.isArray(products) ? products : [];

import LazyImage from '../LazyImage.astro';
---

<div
  class={`products-carousel ${className}`}
  data-autoplay={autoplay}
  data-speed={speed}
  style={{
    '--pc-padding-top': paddingTop,
    '--pc-padding-top-mobile': mobilePaddingTop,
  }}
>
  
  <div class="swiper-container">
    <div class="swiper-wrapper">
      {productsItems.map((product) => (
        <div class="swiper-slide">
          <a 
            href={`/${currentLang}/${currentLang === 'es' ? 'productos' : 'products'}/${product.slug}`}
            class="product-card-cta"
          >
            <div class="product-card">
              <div
                class="product-background"
                style={{
                  '--default-bg': `url(${cardBackgroundImage || DEFAULT_CARD_BACKGROUND_IMAGE})`,
                  '--hover-bg': `url(${product.background_image || cardBackgroundImage || DEFAULT_CARD_BACKGROUND_IMAGE})`,
                  backgroundImage: 'var(--default-bg)',
                }}
              ></div>
              <div class="product-image-container">
                <LazyImage 
                  src={product.imageMobile || product.image} 
                  alt={product.name}
                  class="product-image"
                  width={300}
                  height={400}
                />
              </div>
            </div>
            <p class="product-title">
              {product.name}
            </p>
          </a>
        </div>
      ))}
    </div>
    
    <!-- Navegación -->
    <div class="carousel-controls">
      <button class="carousel-control swiper-button-prev" type="button"></button>
      <button class="carousel-control swiper-button-next" type="button"></button>
    </div>
  </div>
</div>

<style>
  .products-carousel {
    width: 100%;
    padding: 1rem 0;
    overflow: visible;
    padding-top: var(--pc-padding-top, 120px);
  }

  .swiper-container {
    position: relative;
    width: 100%;
    padding: 0 40px;
    overflow: visible; /* Cambiar a visible para permitir overflow */
  }

  .swiper-wrapper {
    display: flex;
    align-items: stretch;
    overflow: visible; /* Asegurar que el wrapper también tenga overflow visible */
  }

  .swiper-slide {
    height: auto;
    display: flex;
    justify-content: center;
    flex-shrink: 0;
    width: auto;
    overflow: visible;
  }

  .product-card-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
  }

  .product-card {
    position: relative;
    width: 260px;
    aspect-ratio: 3 / 4;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-background {
    position: absolute;
    inset: 8%;
    border-radius: 32px;
    background-color: #f5d000; /* fallback */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: opacity 220ms ease;
  }

  .product-background::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background-image: var(--hover-bg);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0;
    transition: opacity 220ms ease;
  }

  @media (hover: hover) {
    .product-card-cta:hover .product-background::after,
    .product-card-cta:focus-visible .product-background::after {
      opacity: 1;
    }

    .product-card-cta:hover .product-card,
    .product-card-cta:focus-visible .product-card {
      animation: cappyHoverBounce 420ms cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }
  }

  @keyframes cappyHoverBounce {
    0% {
      transform: translateY(0) scale(1);
    }
    55% {
      transform: translateY(-6px) scale(1.02);
    }
    100% {
      transform: translateY(0) scale(1);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .product-background,
    .product-background::after {
      transition: none;
    }
    .product-card-cta:hover .product-card,
    .product-card-cta:focus-visible .product-card {
      animation: none;
    }
  }

  .product-image-container {
    position: relative;
    z-index: 2;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10%;
  }

  .product-image-container .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .product-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #004AB2; /* azul de Cappy */
    text-align: left;
    width: 100%;
    max-width: 260px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .products-carousel {
      padding-top: var(--pc-padding-top-mobile, 100px);
    }
    
    .swiper-container {
      padding: 0 24px;
    }

    .product-card {
      width: 220px;
    }

    .product-title {
      max-width: 220px;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    .products-carousel {
      padding-top: var(--pc-padding-top-mobile, 80px);
    }
    
    .swiper-container {
      padding: 0 16px;
    }

    .product-card {
      width: 200px;
    }

    .product-title {
      max-width: 200px;
      font-size: 0.85rem;
    }
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';

  interface ProductsCarouselOptions {
    autoplay?: boolean;
    speed?: number;
    slidesPerView?: number;
    spaceBetween?: number;
    loop?: boolean;
  }

  class ProductsCarousel {
    private container: HTMLElement;
    private swiper: Swiper | null = null;
    private options: ProductsCarouselOptions;

    constructor(container: HTMLElement, options: ProductsCarouselOptions = {}) {
      this.container = container;
      this.options = options;
      this.init();
    }

    private init(): void {
      const swiperContainer = this.container.querySelector('.swiper-container') as HTMLElement;
      
      if (!swiperContainer) return;

      // Add event listeners to prevent swiper from handling link clicks
      const productLinks = swiperContainer.querySelectorAll('a[data-no-swipe]');
      productLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          // Stop propagation to prevent Swiper from handling the click
          e.stopPropagation();
        });
      });

      this.swiper = new Swiper(swiperContainer, {
        modules: [Navigation, Autoplay],
        slidesPerView: this.options.slidesPerView || 3,
        spaceBetween: this.options.spaceBetween || 30,
        loop: this.options.loop !== false,
        autoplay: this.options.autoplay ? {
          delay: this.options.speed || 5000,
          disableOnInteraction: false,
        } : false,
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
        breakpoints: {
          320: {
            slidesPerView: 1,
            spaceBetween: 20,
          },
          768: {
            slidesPerView: 2,
            spaceBetween: 30,
          },
          1024: {
            slidesPerView: this.options.slidesPerView || 3,
            spaceBetween: this.options.spaceBetween || 30,
          },
        },
        // Prevent swiper from handling clicks on links with data-no-animation
        preventClicksPropagation: true,
        preventClicks: false,
        noSwiping: true,
        noSwipingClass: 'swiper-no-swiping',
      });

      // Add swiper-no-swiping class to all links with data-no-swipe attribute
      productLinks.forEach(link => {
        link.classList.add('swiper-no-swiping');
      });
    }

    public destroy(): void {
      if (this.swiper) {
        this.swiper.destroy();
        this.swiper = null;
      }
    }
  }

  // Variable global para almacenar instancias
  let carouselInstances: ProductsCarousel[] = [];

  // Función para limpiar instancias existentes
  function cleanupCarousels() {
    carouselInstances.forEach(instance => instance.destroy());
    carouselInstances = [];
  }

  // Función para inicializar carruseles
  function initializeCarousels() {
    cleanupCarousels();
    
    const carousels = document.querySelectorAll('.products-carousel');
    carousels.forEach((element: Element) => {
      if (element instanceof HTMLElement) {
        const instance = new ProductsCarousel(element, {
          autoplay: element.dataset.autoplay !== 'false',
          speed: parseInt(element.dataset.speed || '5000', 10),
          slidesPerView: 3,
          spaceBetween: 30,
          loop: true,
        });
        carouselInstances.push(instance);
      }
    });
  }

  // Inicializar en DOMContentLoaded
  document.addEventListener('DOMContentLoaded', initializeCarousels);
  // Reinicializar en navegaciones parciales
  document.addEventListener('astro:page-load', initializeCarousels);
  document.addEventListener('astro:after-swap', initializeCarousels);
  // Limpiar antes del swap de Astro
  document.addEventListener('astro:before-swap', cleanupCarousels);
</script> 