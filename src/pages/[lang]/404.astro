---
import MainLayout from '../../layouts/MainLayout.astro';
import LazyImage from '../../components/common/LazyImage.astro';
import { setLocale, t, type Locale } from '../../i18n/i18n';
import { getRouteById } from '../../config/routes';

export async function getStaticPaths() {
  return [
    { params: { lang: 'es' } },
    { params: { lang: 'en' } },
  ];
}

const { lang } = Astro.params as { lang: Locale };
setLocale(lang);

const isEs = lang === 'es';

const homePath = `/${lang}/`;
const productsRoute = getRouteById('products');
const productsPath = productsRoute ? `/${lang}/${productsRoute.slugs[lang]}` : homePath;
const productDetailBasePath = productsPath;

const products = t('items', { namespace: 'products', locale: lang }) || [];
const productsArray = Array.isArray(products) ? products : [];
const fallbackProducts = productsArray.slice(0, 3);

const pageTitle = isEs ? '404 - Página no encontrada' : '404 - Page not found';
const pageDescription = isEs
  ? 'La página que buscas no existe o se movió.'
  : 'The page you are looking for does not exist or has moved.';

const headline = isEs ? '¡Ups! Este crunch se perdió.' : 'Oops! This crunch got lost.';
const body = isEs
  ? 'Parece que llegaste a una bolsa vacía. La ruta que buscabas no está aquí… pero todavía puedes volver a encontrar tu sabor favorito.'
  : "Looks like you reached an empty bag. The route you’re looking for isn’t here… but you can still get back to your favorite flavor.";

const ctaHome = isEs ? 'Volver al inicio' : 'Back to home';
const ctaProducts = isEs ? 'Ver productos' : 'See products';

const randomTitle = isEs ? 'Prueba estos sabores' : 'Try these flavors';
const randomCta = isEs ? 'Ver producto' : 'View product';
---

<MainLayout title={pageTitle} description={pageDescription}>
  <main class="bg-primary w-full flex flex-col items-center justify-center mt-0">
    <section class="w-full bg-yellow py-10 md:py-14">
      <div class="container mx-auto px-4">
        <div class="rounded-[28px] bg-blue p-6 sm:p-8 md:p-10 overflow-hidden">
          <div class="max-w-3xl mx-auto text-center">
            <div class="text-white font-title italic font-extrabold text-7xl sm:text-8xl md:text-9xl leading-[0.9]">
              404
            </div>
            <h1 class="mt-4 text-white font-title italic font-extrabold text-3xl sm:text-4xl md:text-5xl leading-[0.95]">
              {headline}
            </h1>
            <p class="mt-3 sm:mt-4 text-white/90 font-text italic font-medium text-sm sm:text-base md:text-lg mx-auto max-w-2xl">
              {body}
            </p>

            <div class="mt-6 flex flex-col sm:flex-row justify-center gap-3 sm:gap-4">
              <a
                href={homePath}
                class="inline-flex items-center justify-center rounded-full bg-blue text-white border-2 border-white font-title italic font-extrabold px-7 py-3 hover:bg-white hover:text-blue transition-colors"
              >
                {ctaHome}
              </a>
              <a
                href={productsPath}
                class="inline-flex items-center justify-center rounded-full bg-blue text-white border-2 border-white font-title italic font-extrabold px-7 py-3 hover:bg-white hover:text-blue transition-colors"
              >
                {ctaProducts}
              </a>
            </div>
          </div>
        </div>

        {productsArray.length > 0 && (
          <div class="mt-10 md:mt-12">
            <h2 class="text-blue font-title italic font-extrabold text-3xl sm:text-4xl md:text-5xl leading-[0.95]">
              {randomTitle}
            </h2>

            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {fallbackProducts.map((p: any, idx: number) => (
                <a
                  href={`${productDetailBasePath}/${p.id}`}
                  class="random-product group rounded-[24px] border-2 border-blue/20 bg-white/20 p-5 sm:p-6 overflow-hidden"
                  data-product-id={p.id}
                  data-default={idx < 3 ? 'true' : 'false'}
                >
                  <div class="w-full rounded-[18px] bg-white/40 p-4 flex items-center justify-center">
                    <LazyImage
                      src={p.image}
                      alt={p.name}
                      class="w-full max-w-[240px] h-auto object-contain"
                      loading="lazy"
                    />
                  </div>

                  <div class="mt-4 text-blue font-title italic font-extrabold text-xl sm:text-2xl">
                    {p.name}
                  </div>
                  <div class="mt-3 inline-flex items-center justify-center rounded-full bg-blue text-white border-2 border-white font-title italic font-extrabold px-6 py-2 group-hover:bg-white group-hover:text-blue transition-colors">
                    {randomCta}
                  </div>
                </a>
              ))}
            </div>

            <script define:vars={{ productDetailBasePath, randomCta }}>
              const cards = Array.from(document.querySelectorAll('.random-product'));
              if (cards.length > 0) {
                const toShow = Math.min(3, cards.length);
                const shuffled = cards
                  .map((el) => ({ el, sort: Math.random() }))
                  .sort((a, b) => a.sort - b.sort)
                  .map(({ el }) => el);

                cards.forEach((el) => {
                  const isDefault = el.getAttribute('data-default') === 'true';
                  el.style.display = isDefault ? '' : 'none';
                });

                shuffled.forEach((el, idx) => {
                  el.style.display = idx < toShow ? '' : 'none';
                });
              }
            </script>
          </div>
        )}
      </div>
    </section>
  </main>
</MainLayout>
